input {
  tcp {
    port  => 5044
    codec => json
  }

  # Docker コンテナログ
  beats {
    port => 5045
  }
}

filter {
  # Goバックエンドのzapログをパース
  if [logger] {
    mutate {
      add_field => { "app" => "kintai-backend" }
    }
  }

  # タイムスタンプの正規化
  if [ts] {
    date {
      match => ["ts", "ISO8601"]
      target => "@timestamp"
    }
    mutate {
      remove_field => ["ts"]
    }
  }

  # ログレベルの正規化
  if [level] {
    mutate {
      rename => { "level" => "log_level" }
    }
  }

  # HTTPリクエストログのフィールド抽出
  if [msg] == "HTTP Request" {
    mutate {
      add_tag => ["http_request"]
    }
  }

  # エラーログにタグ付け
  if [log_level] in ["error", "fatal", "panic"] {
    mutate {
      add_tag => ["error"]
    }
  }
}

output {
  elasticsearch {
    hosts    => ["http://elasticsearch:9200"]
    index    => "kintai-logs-%{+YYYY.MM.dd}"
  }

  # デバッグ用: 標準出力にも出力
  # stdout { codec => rubydebug }
}
